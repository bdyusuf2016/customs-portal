<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customs Pro | Admin Dashboard 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1a73e8; --success: #1e8e3e; --danger: #d93025; --bg: #f1f3f4;
            --dark: #202124; --card-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; }
        #dashboard { display: none; padding: 20px; }
        
        /* Header & Tabs */
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; border-radius: 8px; }
        .tab-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 12px 24px; border: none; background: #fff; cursor: pointer; border-radius: 25px; font-weight: 600; box-shadow: var(--card-shadow); transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); border-left: 5px solid var(--primary); }
        .stat-card h3 { margin: 0; font-size: 14px; color: #5f6368; }
        .stat-card b { font-size: 24px; color: var(--dark); display: block; margin-top: 5px; }

        /* Filter Panel */
        .filter-panel { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; align-items: end; }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 20px; }
        input, select { padding: 10px; border: 1px solid #dadce0; border-radius: 6px; font-size: 14px; }
        
        /* Table Styles */
        .table-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--card-shadow); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: center; color: #5f6368; font-size: 13px; border-bottom: 2px solid #eee; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #f1f1f1; font-size: 14px; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-excel { background: #1d6f42; color: white; }
        .btn-pay { background: var(--primary); color: white; }
        .btn-edit { background: #fbbc04; color: white; }
        
        .status-paid { color: var(--success); font-weight: bold; background: #e6f4ea; padding: 4px 8px; border-radius: 4px; }
        .status-pending { color: var(--danger); font-weight: bold; background: #fce8e6; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="loginScreen" style="height:100vh; display:flex; justify-content:center; align-items:center; background:#fff;">
    <div class="card" style="text-align:center; width:350px;">
        <h2 style="color:var(--primary)">Customs Pro Admin</h2>
        <div id="g_id_signin"></div>
    </div>
</div>

<div id="dashboard">
    <div class="header">
        <div style="display:flex; align-items:center; gap:12px;">
            <img id="userImg" style="width:40px; border-radius:50%;">
            <div><b id="userName"></b><br><small id="userEmail"></small></div>
        </div>
        <button class="btn" style="background:#eee;" onclick="logout()">Sign Out</button>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('recordsTab', this)">B/E Records</button>
        <button class="tab-btn" onclick="switchTab('collectionTab', this)">Cash Collection</button>
    </div>

    <div id="recordsTab" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card"><h3>Today's Duty</h3><b id="todayDuty">0.00</b></div>
            <div class="stat-card" style="border-left-color: var(--success)"><h3>Today's Cash</h3><b id="todayCash">0.00</b></div>
            <div class="stat-card" style="border-left-color: #fbbc04"><h3>Total Profit</h3><b id="totalProfit">0.00</b></div>
        </div>

        <div class="filter-panel">
            <div><label>Date Filter</label><input type="date" id="filterDate" onchange="applyFilters()"></div>
            <div><label>Payment Method</label>
                <select id="filterMethod" onchange="applyFilters()">
                    <option value="">All Methods</option>
                    <option value="Cash">Cash</option>
                    <option value="Bkash">Bkash</option>
                    <option value="Bank">Bank</option>
                </select>
            </div>
            <div><label>User</label><select id="filterUser" onchange="applyFilters()"><option value="">All Users</option></select></div>
            <button class="btn btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export Excel</button>
        </div>

        <div class="card">
            <form id="beForm" onsubmit="handleSave(event)" class="form-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px;">
                <input type="hidden" id="editId">
                <input type="text" id="ain" placeholder="AIN No" required>
                <input type="text" id="beNo" placeholder="B/E No" required>
                <input type="number" id="duty" placeholder="Duty Amount" step="any" required>
                <button type="submit" class="btn btn-pay" style="justify-content:center;">Save Record</button>
            </form>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Date</th><th>User</th><th>AIN/BE</th><th>Duty</th><th>Cash</th><th>Method</th><th>Status</th><th>Actions</th></tr>
                </thead>
                <tbody id="recordTable"></tbody>
            </table>
        </div>
    </div>

    <div id="collectionTab" class="tab-content" style="display:none;">
        <div class="card"><h3>Cash Collection Features - Coming Soon</h3></div>
    </div>
</div>

<script>
    const API_URL = "https://sheetdb.io/api/v1/vont79v8eejj0";
    let currentUser = null, allData = [];

    window.onload = function() {
        const saved = localStorage.getItem('customsUser');
        if(saved) { currentUser = JSON.parse(saved); init(); }
        else {
            google.accounts.id.initialize({ client_id: "892484000034-a40kgtia2ne0j8g9j42g8jspvou957i7.apps.googleusercontent.com", callback: handleLogin });
            google.accounts.id.renderButton(document.getElementById("g_id_signin"), { theme: "outline", size: "large" });
        }
    }

    function handleLogin(res) {
        currentUser = JSON.parse(atob(res.credential.split('.')[1]));
        localStorage.setItem('customsUser', JSON.stringify(currentUser));
        init();
    }

    function init() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('userName').innerText = currentUser.name;
        document.getElementById('userEmail').innerText = currentUser.email;
        document.getElementById('userImg').src = currentUser.picture;
        loadData();
    }

    async function loadData() {
        const res = await fetch(API_URL);
        allData = await res.json();
        populateUserFilter();
        applyFilters();
    }

    function applyFilters() {
        const dateVal = document.getElementById('filterDate').value;
        const methodVal = document.getElementById('filterMethod').value;
        const userVal = document.getElementById('filterUser').value;

        let filtered = allData;

        if(dateVal) {
            const formattedDate = dateVal.split('-').reverse().join('-');
            filtered = filtered.filter(r => r.date === formattedDate);
        }
        if(methodVal) filtered = filtered.filter(r => r.method === methodVal);
        if(userVal) filtered = filtered.filter(r => r.user === userVal);

        renderTable(filtered);
    }

    function renderTable(data) {
        const tbody = document.getElementById('recordTable');
        const today = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
        
        let tDuty = 0, tCash = 0, netProfit = 0;

        tbody.innerHTML = data.slice().reverse().map(item => {
            const d = parseFloat(item.duty || 0);
            const c = parseFloat(item.cash || 0);
            const isPaid = item.status === 'Paid';

            if(item.date === today) { tDuty += d; tCash += c; }
            if(isPaid) netProfit += (c - d);

            return `<tr>
                <td>${item.date}</td>
                <td><small>${item.user ? item.user.split('@')[0] : 'N/A'}</small></td>
                <td><b>${item.ain}</b><br>${item.beNo}</td>
                <td>${d.toFixed(2)}</td><td>${c.toFixed(2)}</td>
                <td>${item.method || '-'}</td>
                <td><span class="${isPaid ? 'status-paid' : 'status-pending'}">${item.status}</span></td>
                <td>
                    ${!isPaid ? `<button class="btn btn-pay" onclick="payNow('${item.beNo}', ${d})">Pay</button>` : ''}
                    <button class="btn btn-edit" onclick="editItem('${item.beNo}')"><i class="fas fa-edit"></i></button>
                </td>
            </tr>`;
        }).join('');

        document.getElementById('todayDuty').innerText = tDuty.toFixed(2);
        document.getElementById('todayCash').innerText = tCash.toFixed(2);
        document.getElementById('totalProfit').innerText = netProfit.toFixed(2);
    }

    async function payNow(beNo, duty) {
        const cash = prompt("Received Amount?", duty);
        const method = prompt("Method (Cash/Bkash/Bank)?", "Cash");
        if(!cash || !method) return;

        await fetch(`${API_URL}/beNo/${beNo}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: 'Paid', cash: cash, method: method, profit: (cash - duty).toFixed(2) })
        });
        loadData();
    }

    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(allData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Records");
        XLSX.writeFile(wb, "Customs_Report.xlsx");
    }

    function populateUserFilter() {
        const users = [...new Set(allData.map(r => r.user))];
        const select = document.getElementById('filterUser');
        select.innerHTML = '<option value="">All Users</option>' + 
            users.map(u => `<option value="${u}">${u ? u.split('@')[0] : 'Unknown'}</option>`).join('');
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).style.display = 'block';
        btn.classList.add('active');
    }

    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
