<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Customs Pro - Google Auth System</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; }
        #loginScreen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: white; }
        .dashboard { display: none; padding: 20px; max-width: 1400px; margin: auto; }
        
        /* Profile Section */
        .user-profile { display: flex; align-items: center; gap: 10px; background: #fff; padding: 5px 15px; border-radius: 50px; border: 1px solid #ddd; }
        .user-profile img { width: 35px; height: 35px; border-radius: 50%; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .sum-item { background: #2c3e50; color: white; padding: 15px; border-radius: 10px; text-align: center; }
        .sum-item b { font-size: 20px; color: #ffc107; display: block; }
        
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: center; }
        th { background: #f8f9fa; }
        
        .btn-logout { background: #ff4d4d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="loginScreen">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Google_%22G%22_Logo.svg/512px-Google_%22G%22_Logo.svg.png" width="50" alt="Google">
    <h2>Customs B/E Portal</h2>
    <p>আপনার প্রাতিষ্ঠানিক জিমেইল দিয়ে লগইন করুন</p>
    <div id="buttonDiv"></div>
</div>

<div id="dashboard" class="dashboard">
    <div class="header">
        <h2 style="color: #1a73e8; margin: 0;">Dashboard Overview</h2>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="user-profile">
                <img id="userImg" src="" alt="User">
                <span id="userName" style="font-weight: bold; font-size: 14px;"></span>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="card" id="entryArea">
        <form id="beForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <input type="text" id="ain" placeholder="AIN No" oninput="autoFillName()" required>
            <input type="text" id="declarant" placeholder="Declarant Name" readonly>
            <input type="text" id="beNo" placeholder="B/E Number" required>
            <input type="number" id="duty" placeholder="Duty Amount" required>
            <button type="submit" style="background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer;">Save Record</button>
        </form>
    </div>

    <div class="summary-grid">
        <div class="sum-item">Total Records <b id="countTotal">0</b></div>
        <div class="sum-item">My Entries <b id="countMine">0</b></div>
        <div class="sum-item">Total Duty <b id="sumDuty">0</b></div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Entered By (Email)</th>
                <th>B/E Info</th>
                <th>Duty</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="dataTable"></tbody>
    </table>
</div>

<script>
    const CLIENT_ID = "892484000034-a40kgtia2ne0j8g9j42g8jspvou957i7.apps.googleusercontent.com"; 
    const API_URL = "https://sheetdb.io/api/v1/vont79v8eejj0";
    let userData = null;

    // ১. গুগল লগইন সেটআপ
    window.onload = function () {
        google.accounts.id.initialize({
            client_id: CLIENT_ID,
            callback: handleCredentialResponse
        });
        google.accounts.id.renderButton(
            document.getElementById("buttonDiv"),
            { theme: "outline", size: "large", width: 250 }
        );
    }

    function handleCredentialResponse(response) {
        // টোকেন ডিকোড করে ইউজারের তথ্য নেওয়া
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        userData = payload;
        
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        
        document.getElementById('userName').innerText = userData.email;
        document.getElementById('userImg').src = userData.picture;
        
        fetchRecords();
    }

    function logout() {
        location.reload();
    }

    // ২. ডাটাবেজ কাজ
    async function fetchRecords() {
        const res = await fetch(API_URL);
        const data = await res.json();
        renderData(data);
    }

    function renderData(data) {
        const tbody = document.getElementById('dataTable');
        tbody.innerHTML = '';
        let mine = 0, totalDuty = 0;

        data.slice().reverse().forEach(item => {
            // সিকিউরিটি ফিল্টার: অ্যাডমিন না হলে শুধু নিজের ডাটা দেখবে
            const isAdmin = (userData.email === "admin@gmail.com"); // আপনার অ্যাডমিন মেইল দিন
            if (isAdmin || item.user === userData.email) {
                if (item.user === userData.email) mine++;
                totalDuty += parseFloat(item.duty || 0);

                tbody.innerHTML += `
                    <tr>
                        <td>${item.date}</td>
                        <td><small>${item.user}</small></td>
                        <td>${item.beNo}</td>
                        <td>${item.duty}</td>
                        <td style="color:${item.status === 'Paid' ? 'green' : 'red'}">${item.status}</td>
                    </tr>`;
            }
        });

        document.getElementById('countTotal').innerText = data.length;
        document.getElementById('countMine').innerText = mine;
        document.getElementById('sumDuty').innerText = totalDuty.toFixed(2);
    }

    document.getElementById('beForm').onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
            date: new Date().toLocaleDateString('en-GB').replace(/\//g, '-'),
            user: userData.email, // জিমেইল আইডি সেভ হবে
            beNo: document.getElementById('beNo').value,
            duty: document.getElementById('duty').value,
            status: 'Pending'
        };
        await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ data: [payload] })
        });
        document.getElementById('beForm').reset();
        fetchRecords();
    };
</script>
</body>
</html>
