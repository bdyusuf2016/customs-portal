<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customs Pro | 2026 Full Entry Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1a73e8; --success: #1e8e3e; --danger: #d93025; --bg: #f8f9fa;
            --dark: #202124; --card-shadow: 0 1px 3px rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: var(--bg); margin: 0; }
        #dashboard { display: none; padding: 20px; max-width: 1400px; margin: 0 auto; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--dark); color: white; padding: 20px; border-radius: 12px; text-align: center; border-bottom: 5px solid var(--primary); }
        .stat-card b { font-size: 24px; color: #ffc107; display: block; margin-top: 8px; }

        /* Save Form Style */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 20px; }
        .form-header { background: var(--primary); color: white; padding: 12px 20px; border-radius: 12px 12px 0 0; margin: -20px -20px 20px -20px; font-weight: bold; }
        
        input, select { padding: 10px; border: 1px solid #dadce0; border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box; }
        .btn { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
        .btn-save { background: var(--success); color: white; justify-content: center; width: 100%; font-size: 16px; margin-top: 10px; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f1f3f4; padding: 12px; border-bottom: 2px solid #eee; font-size: 13px; color: #5f6368; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
        .status-paid { color: var(--success); font-weight: bold; background: #e6f4ea; padding: 4px 8px; border-radius: 4px; }
        .status-pending { color: var(--danger); font-weight: bold; background: #fce8e6; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="loginScreen" style="height:100vh; display:flex; justify-content:center; align-items:center;">
    <div class="card" style="text-align:center; width:350px;">
        <h2 style="color:var(--primary)">Customs Admin</h2>
        <div id="g_id_signin"></div>
    </div>
</div>

<div id="dashboard">
    <div class="header">
        <div style="display:flex; align-items:center; gap:12px;">
            <img id="userImg" style="width:40px; border-radius:50%;">
            <b id="userName"></b>
        </div>
        <button class="btn" style="background:#eee;" onclick="logout()">Logout</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">Total Duty <b id="sumDuty">0.00</b></div>
        <div class="stat-card">Total Cash <b id="sumCash">0.00</b></div>
        <div class="stat-card">Net Profit <b id="sumProfit">0.00</b></div>
    </div>

    <div class="card">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; align-items: end;">
            <div><label>Start Date</label><input type="date" id="startDate" onchange="filterData()"></div>
            <div><label>End Date</label><input type="date" id="endDate" onchange="filterData()"></div>
            <button class="btn" style="border:1px solid var(--primary); color:var(--primary)" onclick="setToday()">Today</button>
            <select id="userFilter" onchange="filterData()"><option value="">All Users</option></select>
            <button class="btn" style="background:#1d6f42; color:white;" onclick="exportExcel()">Export</button>
        </div>
    </div>

    <div class="card">
        <div class="form-header"><i class="fas fa-edit"></i> Entry B/E & Payment Details</div>
        <form id="beForm" onsubmit="saveBE(event)">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
                <div><label>AIN No</label><input type="text" id="ain" oninput="autoFill(this.value)" required></div>
                <div><label>Declarant Name</label><input type="text" id="declarant" readonly style="background:#f1f3f4;"></div>
                <div><label>B/E No</label><input type="text" id="beNo" required></div>
                <div><label>Duty Amount</label><input type="number" id="duty" step="any" required></div>
                <div><label>Cash Received</label><input type="number" id="cashRec" step="any" placeholder="0.00"></div>
                <div><label>Payment Method</label>
                    <select id="payMethod">
                        <option value="Cash">Cash</option>
                        <option value="Bkash">Bkash</option>
                        <option value="Bank">Bank</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-save"><i class="fas fa-check-circle"></i> Confirm & Save Record</button>
        </form>
    </div>

    <div class="card" style="padding:0; overflow-x:auto;">
        <table>
            <thead>
                <tr><th>Date</th><th>Declarant</th><th>AIN/BE</th><th>Duty</th><th>Cash</th><th>Profit</th><th>Method</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody id="beTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = "https://sheetdb.io/api/v1/vont79v8eejj0";
    let currentUser = null, allData = [], ainData = [];

    window.onload = function() {
        const saved = localStorage.getItem('customsUser');
        if(saved) { currentUser = JSON.parse(saved); initDash(); }
        else {
            google.accounts.id.initialize({ client_id: "892484000034-a40kgtia2ne0j8g9j42g8jspvou957i7.apps.googleusercontent.com", callback: res => {
                currentUser = JSON.parse(atob(res.credential.split('.')[1]));
                localStorage.setItem('customsUser', JSON.stringify(currentUser));
                initDash();
            }});
            google.accounts.id.renderButton(document.getElementById("g_id_signin"), {theme:"outline", size:"large"});
        }
    }

    async function initDash() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('userName').innerText = currentUser.name;
        document.getElementById('userImg').src = currentUser.picture;
        
        // AIN List load
        fetch(API_URL + "?sheet=AIN_List").then(r => r.json()).then(d => ainData = d);
        setToday();
    }

    function setToday() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;
        loadRecords();
    }

    async function loadRecords() {
        const res = await fetch(API_URL);
        allData = await res.json();
        updateUserFilter();
        filterData();
    }

    function autoFill(v) {
        const f = ainData.find(i => String(i.ain) === v.trim());
        document.getElementById('declarant').value = f ? f.name : "Not Found";
    }

    function filterData() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const user = document.getElementById('userFilter').value;

        const filtered = allData.filter(r => {
            if(!r.date) return false;
            const [d, m, y] = r.date.split('-');
            const recordDate = `${y}-${m}-${d}`;
            let dateMatch = (start && end) ? (recordDate >= start && recordDate <= end) : true;
            let userMatch = !user || r.user === user;
            return dateMatch && userMatch;
        });
        renderTable(filtered);
    }

    function renderTable(data) {
        const tbody = document.getElementById('beTableBody');
        let dSum = 0, cSum = 0, pSum = 0;

        tbody.innerHTML = data.slice().reverse().map(item => {
            const d = parseFloat(item.duty || 0);
            const c = parseFloat(item.cash || 0);
            const p = parseFloat(item.profit || 0);
            const isPaid = item.status === 'Paid';
            dSum += d; cSum += c; pSum += p;

            return `<tr>
                <td>${item.date}</td><td>${item.name || '-'}</td>
                <td><b>${item.ain}</b><br>${item.beNo}</td>
                <td>${d.toFixed(2)}</td><td>${c.toFixed(2)}</td>
                <td style="color:${p>0?'green':''}">${p.toFixed(2)}</td>
                <td>${item.method || '-'}</td>
                <td><span class="${isPaid ? 'status-paid' : 'status-pending'}">${item.status}</span></td>
                <td>
                    <button class="btn btn-del" onclick="deleteItem('${item.beNo}')" style="background:#fce8e6; color:var(--danger); padding:5px 8px;"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('');

        document.getElementById('sumDuty').innerText = dSum.toFixed(2);
        document.getElementById('sumCash').innerText = cSum.toFixed(2);
        document.getElementById('sumProfit').innerText = pSum.toFixed(2);
    }

    async function saveBE(e) {
        e.preventDefault();
        const dAmt = parseFloat(document.getElementById('duty').value);
        const cRec = parseFloat(document.getElementById('cashRec').value || 0);
        
        const payload = {
            date: new Date().toLocaleDateString('en-GB').replace(/\//g, '-'),
            ain: document.getElementById('ain').value,
            name: document.getElementById('declarant').value,
            beNo: document.getElementById('beNo').value,
            duty: dAmt,
            cash: cRec,
            method: document.getElementById('payMethod').value,
            status: cRec > 0 ? 'Paid' : 'Pending',
            profit: cRec > 0 ? (cRec - dAmt).toFixed(2) : 0,
            user: currentUser.email
        };

        await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({data: [payload]})});
        loadRecords(); e.target.reset();
    }

    async function deleteItem(id) {
        if(confirm("Are you sure?")) {
            await fetch(`${API_URL}/beNo/${id}`, { method: 'DELETE' });
            loadRecords();
        }
    }

    function updateUserFilter() {
        const users = [...new Set(allData.map(r => r.user))];
        const select = document.getElementById('userFilter');
        select.innerHTML = '<option value="">All Users</option>' + users.map(u => `<option value="${u}">${u ? u.split('@')[0] : 'N/A'}</option>`).join('');
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(allData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "B_E_Records");
        XLSX.writeFile(wb, "Customs_Full_Report.xlsx");
    }

    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
